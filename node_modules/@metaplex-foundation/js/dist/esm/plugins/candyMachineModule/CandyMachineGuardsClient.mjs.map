{"version":3,"file":"CandyMachineGuardsClient.mjs","sources":["../../../../src/plugins/candyMachineModule/CandyMachineGuardsClient.ts"],"sourcesContent":["import { Buffer } from 'buffer';\nimport * as beet from '@metaplex-foundation/beet';\nimport { AccountMeta } from '@solana/web3.js';\nimport { CANDY_GUARD_LABEL_SIZE } from './constants';\nimport {\n  GuardGroupLabelTooLongError,\n  GuardGroupRequiredError,\n  GuardNotEnabledError,\n  GuardRouteNotSupportedError,\n  SelectedGuardGroupDoesNotExistError,\n  UnregisteredCandyGuardError,\n} from './errors';\nimport {\n  CandyGuardManifest,\n  CandyGuardsMintSettings,\n  CandyGuardsRemainingAccount,\n  CandyGuardsRouteSettings,\n  CandyGuardsSettings,\n  DefaultCandyGuardRouteSettings,\n  DefaultCandyGuardSettings,\n} from './guards';\nimport { CandyGuard } from './models';\nimport { CandyGuardProgram } from './programs';\nimport { Option, padEmptyChars, removeEmptyChars } from '@/utils';\nimport {\n  deserialize,\n  deserializeFeatureFlags,\n  Program,\n  PublicKey,\n  serialize,\n  serializeFeatureFlags,\n  Signer,\n} from '@/types';\nimport type { Metaplex } from '@/Metaplex';\n\n/**\n * This client enables us to register custom guards from\n * custom Candy Guard programs and interact with them.\n *\n * @see {@link CandyGuardClient}\n * @group Module\n */\nexport class CandyMachineGuardsClient {\n  readonly guards: CandyGuardManifest<any, any, any>[] = [];\n\n  constructor(protected readonly metaplex: Metaplex) {}\n\n  /** Registers one or many guards by providing their manifest. */\n  register(...guard: CandyGuardManifest<any, any, any>[]) {\n    this.guards.push(...guard);\n  }\n\n  /** Gets the manifest of a guard using its name. */\n  get(name: string): CandyGuardManifest<any, any, any> {\n    const guard = this.guards.find((guard) => guard.name === name);\n\n    if (!guard) {\n      throw new UnregisteredCandyGuardError(name);\n    }\n\n    return guard;\n  }\n\n  /** Gets all registered guard manifests. */\n  all(): CandyGuardManifest<any, any, any>[] {\n    return this.guards;\n  }\n\n  /**\n   * Gets all guard manifests for a registered Candy Guard program.\n   *\n   * It fails if the manifest of any guard expected by the program\n   * is not registered. Manifests are returned in the order in which\n   * they are defined on the `availableGuards` property of the program.\n   */\n  forProgram(\n    program: string | PublicKey | CandyGuardProgram = 'CandyGuardProgram'\n  ): CandyGuardManifest<any, any, any>[] {\n    const candyGuardProgram =\n      typeof program === 'object' && 'availableGuards' in program\n        ? program\n        : this.metaplex.programs().get<CandyGuardProgram>(program);\n\n    return candyGuardProgram.availableGuards.map((name) => this.get(name));\n  }\n\n  /**\n   * Gets all guard manifests for the registered Candy Guard program.\n   *\n   * @see {@link CandyMachineGuardsClient.forProgram}\n   */\n  forCandyGuardProgram(\n    programs: Program[] = []\n  ): CandyGuardManifest<any, any, any>[] {\n    const candyGuardProgram = this.metaplex.programs().getCandyGuard(programs);\n\n    return this.forProgram(candyGuardProgram);\n  }\n\n  /** Serializes the settings of all guards and groups. */\n  serializeSettings<T extends CandyGuardsSettings = DefaultCandyGuardSettings>(\n    guards: Partial<T>,\n    groups: { label: string; guards: Partial<T> }[] = [],\n    programs: Program[] = []\n  ): Buffer {\n    const availableGuards = this.forCandyGuardProgram(programs);\n    const serializeSet = (set: Partial<T>): Buffer => {\n      const { features, buffer } = availableGuards.reduce(\n        (acc, guard, index) => {\n          const value = set[guard.name] ?? null;\n          acc.features[index] = Boolean(value);\n          if (value) {\n            acc.buffer = Buffer.concat([\n              acc.buffer,\n              serialize(value, guard.settingsSerializer),\n            ]);\n          }\n          return acc;\n        },\n        {\n          features: [] as boolean[],\n          buffer: Buffer.from([]),\n        }\n      );\n\n      return Buffer.concat([serializeFeatureFlags(features, 8), buffer]);\n    };\n\n    let buffer = serializeSet(guards);\n\n    const groupCountBuffer = Buffer.alloc(4);\n    beet.u32.write(groupCountBuffer, 0, groups.length);\n    buffer = Buffer.concat([buffer, groupCountBuffer]);\n\n    groups.forEach((group) => {\n      if (group.label.length > CANDY_GUARD_LABEL_SIZE) {\n        throw new GuardGroupLabelTooLongError(\n          group.label,\n          CANDY_GUARD_LABEL_SIZE\n        );\n      }\n      const labelBuffer = Buffer.alloc(CANDY_GUARD_LABEL_SIZE);\n      labelBuffer.write(\n        padEmptyChars(group.label, CANDY_GUARD_LABEL_SIZE),\n        0,\n        CANDY_GUARD_LABEL_SIZE,\n        'utf8'\n      );\n      buffer = Buffer.concat([buffer, labelBuffer, serializeSet(group.guards)]);\n    });\n\n    return buffer;\n  }\n\n  /** Deserializes the settings of all guards and groups. */\n  deserializeSettings<\n    T extends CandyGuardsSettings = DefaultCandyGuardSettings\n  >(\n    buffer: Buffer,\n    program: string | PublicKey | CandyGuardProgram = 'CandyGuardProgram'\n  ): { guards: T; groups: { label: string; guards: T }[] } {\n    const availableGuards = this.forProgram(program);\n    const deserializeSet = () => {\n      const serializedFeatures = buffer.slice(0, 8);\n      const features = deserializeFeatureFlags(serializedFeatures, 64)[0];\n      buffer = buffer.slice(8);\n\n      return availableGuards.reduce((acc, guard, index) => {\n        const isEnabled = features[index] ?? false;\n        acc[guard.name] = null;\n        if (!isEnabled) return acc;\n\n        const [settings] = deserialize(buffer, guard.settingsSerializer);\n        buffer = buffer.slice(guard.settingsBytes);\n        acc[guard.name] = settings;\n        return acc;\n      }, {} as CandyGuardsSettings) as T;\n    };\n\n    const guards: T = deserializeSet();\n    const groups: { label: string; guards: T }[] = [];\n    const groupsCount = beet.u32.read(buffer, 0);\n    buffer = buffer.slice(4);\n\n    for (let i = 0; i < groupsCount; i++) {\n      const label = removeEmptyChars(\n        buffer.slice(0, CANDY_GUARD_LABEL_SIZE).toString('utf8')\n      );\n      buffer = buffer.slice(CANDY_GUARD_LABEL_SIZE);\n      groups.push({ label, guards: deserializeSet() });\n    }\n\n    return { guards, groups };\n  }\n\n  /**\n   * Resolves the set of settings that should be used when minting.\n   *\n   * If no group exists, the `guards` settings will be used.\n   * Otherwise, the `guards` settings will act as default settings and\n   * the settings of the selected group will override them.\n   */\n  resolveGroupSettings<\n    T extends CandyGuardsSettings = DefaultCandyGuardSettings\n  >(\n    guards: T,\n    groups: { label: string; guards: T }[] = [],\n    groupLabel: Option<string>\n  ): T {\n    const availableGroups = groups.map((group) => group.label);\n    const activeGroup = groups.find((group) => group.label === groupLabel);\n    if (groupLabel && !activeGroup) {\n      throw new SelectedGuardGroupDoesNotExistError(\n        groupLabel,\n        availableGroups\n      );\n    }\n\n    if (groups.length === 0) {\n      return guards;\n    }\n\n    if (!activeGroup) {\n      throw new GuardGroupRequiredError(availableGroups);\n    }\n\n    const activeGroupGuardsWithoutNullGuards = Object.fromEntries(\n      Object.entries(activeGroup.guards).filter(([, v]) => v != null)\n    ) as Partial<T>;\n\n    return {\n      ...guards,\n      ...activeGroupGuardsWithoutNullGuards,\n    };\n  }\n\n  /**\n   * Parses the arguments and remaining accounts of\n   * all relevant guards for the mint instruction.\n   */\n  parseMintSettings<\n    Settings extends CandyGuardsSettings = DefaultCandyGuardSettings,\n    MintSettings extends CandyGuardsMintSettings = {}\n  >(\n    candyMachine: PublicKey,\n    candyGuard: CandyGuard<Settings>,\n    payer: Signer,\n    guardMintSettings: Partial<MintSettings>,\n    groupLabel: Option<string>,\n    programs: Program[] = []\n  ): {\n    arguments: Buffer;\n    accountMetas: AccountMeta[];\n    signers: Signer[];\n  } {\n    const availableGuards = this.forCandyGuardProgram(programs);\n    const guardSettings = this.resolveGroupSettings(\n      candyGuard.guards,\n      candyGuard.groups,\n      groupLabel\n    );\n    const initialAccumulator = {\n      arguments: Buffer.from([]),\n      accountMetas: [] as AccountMeta[],\n      signers: [] as Signer[],\n    };\n\n    return availableGuards.reduce((acc, guard) => {\n      const settings = guardSettings[guard.name] ?? null;\n      const mintSettings = guardMintSettings[guard.name] ?? null;\n      if (!guard.mintSettingsParser || !settings) return acc;\n\n      const parsedSettings = guard.mintSettingsParser({\n        metaplex: this.metaplex,\n        settings,\n        mintSettings,\n        payer,\n        candyMachine,\n        candyGuard: candyGuard.address,\n        programs,\n      });\n\n      const accounts = this.getAccountMetas(parsedSettings.remainingAccounts);\n      const signers = this.getSigners(parsedSettings.remainingAccounts);\n      acc.arguments = Buffer.concat([acc.arguments, parsedSettings.arguments]);\n      acc.accountMetas.push(...accounts);\n      acc.signers.push(...signers);\n      return acc;\n    }, initialAccumulator);\n  }\n\n  /**\n   * Parses the arguments and remaining accounts of\n   * the requested guard for the route instruction.\n   */\n  parseRouteSettings<\n    Guard extends keyof RouteSettings & string,\n    Settings extends CandyGuardsSettings = DefaultCandyGuardSettings,\n    RouteSettings extends CandyGuardsRouteSettings = DefaultCandyGuardRouteSettings\n  >(\n    candyMachine: PublicKey,\n    candyGuard: CandyGuard<Settings>,\n    payer: Signer,\n    guard: Guard,\n    routeSettings: RouteSettings[Guard],\n    groupLabel: Option<string>,\n    programs: Program[] = []\n  ): {\n    arguments: Buffer;\n    accountMetas: AccountMeta[];\n    signers: Signer[];\n  } {\n    const guardManifest = this.get(guard);\n    if (!guardManifest.routeSettingsParser) {\n      throw new GuardRouteNotSupportedError(guard);\n    }\n\n    const guardSettings = this.resolveGroupSettings(\n      candyGuard.guards,\n      candyGuard.groups,\n      groupLabel\n    );\n    const settings = guardSettings[guard] ?? null;\n    if (!settings) {\n      throw new GuardNotEnabledError(guard, groupLabel);\n    }\n\n    const parsedSettings = guardManifest.routeSettingsParser({\n      metaplex: this.metaplex,\n      settings,\n      routeSettings,\n      payer,\n      candyMachine,\n      candyGuard: candyGuard.address,\n      programs,\n    });\n\n    return {\n      arguments: parsedSettings.arguments,\n      accountMetas: this.getAccountMetas(parsedSettings.remainingAccounts),\n      signers: this.getSigners(parsedSettings.remainingAccounts),\n    };\n  }\n\n  /** @internal */\n  protected getAccountMetas(\n    remainingAccounts: CandyGuardsRemainingAccount[]\n  ): AccountMeta[] {\n    return remainingAccounts.map((account) => ({\n      pubkey: account.isSigner ? account.address.publicKey : account.address,\n      isSigner: account.isSigner,\n      isWritable: account.isWritable,\n    }));\n  }\n\n  /** @internal */\n  protected getSigners(\n    remainingAccounts: CandyGuardsRemainingAccount[]\n  ): Signer[] {\n    return remainingAccounts\n      .filter((account) => account.isSigner)\n      .map((account) => account.address as Signer);\n  }\n}\n"],"names":["CandyMachineGuardsClient","constructor","metaplex","register","guard","guards","push","get","name","find","UnregisteredCandyGuardError","all","forProgram","program","candyGuardProgram","programs","availableGuards","map","forCandyGuardProgram","getCandyGuard","serializeSettings","groups","serializeSet","set","features","buffer","reduce","acc","index","value","Boolean","Buffer","concat","serialize","settingsSerializer","from","serializeFeatureFlags","groupCountBuffer","alloc","beet","u32","write","length","forEach","group","label","CANDY_GUARD_LABEL_SIZE","GuardGroupLabelTooLongError","labelBuffer","padEmptyChars","deserializeSettings","deserializeSet","serializedFeatures","slice","deserializeFeatureFlags","isEnabled","settings","deserialize","settingsBytes","groupsCount","read","i","removeEmptyChars","toString","resolveGroupSettings","groupLabel","availableGroups","activeGroup","SelectedGuardGroupDoesNotExistError","GuardGroupRequiredError","activeGroupGuardsWithoutNullGuards","Object","fromEntries","entries","filter","v","parseMintSettings","candyMachine","candyGuard","payer","guardMintSettings","guardSettings","initialAccumulator","arguments","accountMetas","signers","mintSettings","mintSettingsParser","parsedSettings","address","accounts","getAccountMetas","remainingAccounts","getSigners","parseRouteSettings","routeSettings","guardManifest","routeSettingsParser","GuardRouteNotSupportedError","GuardNotEnabledError","account","pubkey","isSigner","publicKey","isWritable"],"mappings":"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"}